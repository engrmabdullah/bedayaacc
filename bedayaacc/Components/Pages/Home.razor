@page "/"
@attribute [AllowAnonymous]
@using bedayaacc.Components.Coms
@using bedayaacc.Components.Courses
@using bedayaacc.Components.Layout
@layout ExternalLayout
@inject bedayaacc.Services.TranslationService T
@inject bedayaacc.Services.Repositories.ICourseRepository CourseRepo

<PageTitle>@Tr("Nav.Home")</PageTitle>

<AccountingHeroSection />
<FeaturesSection />
<CoursesSection />
<TestimonialsSection />
<StatsSection />


@code {
    private IReadOnlyList<bedayaacc.Models.CourseDto>? _latest;
    string Tr(string k) => TranslationService.Translate(k);

    protected override void OnInitialized()
    {
        T.OnLanguageChanged += HandleLanguageChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await T.EnsureInitAfterRenderAsync();
            _latest = await CourseRepo.GetLatestAsync(6, T.CurrentLanguage);
            StateHasChanged();
        }
    }

    private async void HandleLanguageChanged()
    {
        try
        {
            var latest = await CourseRepo.GetLatestAsync(6, T.CurrentLanguage);
            await InvokeAsync(() =>
            {
                _latest = latest;
                StateHasChanged();
            });
        }
        catch
        {
            // Handle error silently
        }
    }

    public void Dispose()
    {
        T.OnLanguageChanged -= HandleLanguageChanged;
    }
}